<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Analyzer - Upload & Extract</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
        }

        .subtitle {
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(102, 126, 234, 0.05);
            user-select: none;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.1);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.2);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4em;
            color: #667eea;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #666;
            font-size: 0.9em;
        }

        #fileInput {
            display: none;
        }

        .preview-container {
            margin: 30px 0;
            display: none;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .analyze-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .analyze-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .download-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
        }

        .download-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #218838 0%, #1a9e7e 100%);
        }

        .clear-btn {
            background: transparent;
            color: #666;
            border: 2px solid #ddd;
        }

        .clear-btn:hover:not(:disabled) {
            background: #f5f5f5;
            border-color: #bbb;
        }

        .loading {
            display: none;
            margin: 30px 0;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .attendees-section {
            margin: 30px 0;
            padding: 25px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 15px;
        }

        .attendees-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        #attendeesInput {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            resize: vertical;
            min-height: 80px;
            transition: border-color 0.3s ease;
        }

        #attendeesInput:focus {
            outline: none;
            border-color: #667eea;
        }

        .attendees-preview {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .attendee-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .results {
            margin-top: 40px;
            padding: 30px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 15px;
            display: none;
        }

        .results h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .bill-summary {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .summary-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1em;
            color: #667eea;
        }

        .splitting-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        th, td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .item-column {
            text-align: left;
            min-width: 200px;
            max-width: 250px;
            word-break: break-word;
        }

        .person-row {
            background: rgba(102, 126, 234, 0.05);
        }

        .total-row {
            background: rgba(102, 126, 234, 0.1);
            font-weight: bold;
        }

        .tax-column {
            background: rgba(255, 193, 7, 0.1);
            font-weight: 600;
        }

        .total-column {
            background: rgba(40, 167, 69, 0.1);
            font-weight: 700;
            color: #28a745;
        }

        .checkbox-cell {
            padding: 8px;
        }

        .checkbox-cell input[type="checkbox"] {
            transform: scale(1.2);
            cursor: pointer;
        }

        .amount-cell {
            font-weight: 500;
            color: #333;
        }

        .key-value-pair {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            margin: 10px 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }

        .key-value-pair:hover {
            transform: translateY(-2px);
        }

        .key {
            font-weight: 600;
            color: #333;
            text-transform: capitalize;
        }

        .value {
            color: #666;
            text-align: right;
            max-width: 60%;
            word-break: break-word;
        }

        .error {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .success-animation {
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 600px) {
            .container {
                padding: 30px 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .upload-area {
                padding: 40px 15px;
            }
            
            .key-value-pair {
                flex-direction: column;
                align-items: flex-start;
                text-align: left;
            }
            
            .value {
                max-width: 100%;
                margin-top: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📄 Bill Analyzer & Splitter</h1>
        <p class="subtitle">Upload your bill image and split costs among friends with AI</p>
        
        <div class="attendees-section">
            <h3>👥 Who's attending?</h3>
            <textarea id="attendeesInput" placeholder="Enter names separated by commas (e.g., John, Sarah, Mike, Lisa)"></textarea>
            <div class="attendees-preview" id="attendeesPreview"></div>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">📷</div>
            <div class="upload-text">Click to upload or drag and drop</div>
            <div class="upload-subtext">Supports JPG, PNG, GIF, WebP (Max 10MB)</div>
        </div>

        <input type="file" id="fileInput" accept="image/*" />

        <div class="preview-container" id="previewContainer">
            <img id="previewImage" class="preview-image" alt="Preview" />
        </div>

        <button class="analyze-btn" id="analyzeBtn" disabled>
            🔍 Analyze Bill
        </button>
        <button class="analyze-btn clear-btn" id="clearBtn" style="display: none;">
            🗑️ Clear
        </button>
        <button class="analyze-btn download-btn" id="downloadBtn" style="display: none;">
            📄 Download PDF
        </button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Analyzing your bill with AI...</p>
        </div>

        <div class="error" id="error"></div>

        <div class="results" id="results">
            <h3>📊 Bill Analysis & Splitting</h3>
            <div id="billSummary"></div>
            <div id="splittingTable"></div>
        </div>
    </div>

    <script>
        // API Configuration - Using environment variables for security
        const API_CONFIG = {
            baseURL: "https://router.huggingface.co/v1",
            apiKey: window.HUGGINGFACE_API_KEY || "",
            model: "zai-org/GLM-4.5V:novita"
        };

        // Debug API key availability
        console.log('API Key available:', !!API_CONFIG.apiKey);

        // DOM Elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const clearBtn = document.getElementById('clearBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const results = document.getElementById('results');
        const attendeesInput = document.getElementById('attendeesInput');
        const attendeesPreview = document.getElementById('attendeesPreview');
        const billSummary = document.getElementById('billSummary');
        const splittingTable = document.getElementById('splittingTable');

        let selectedFile = null;
        let imageDataUrl = null;
        let attendees = [];
        let billData = null;

        // Event Listeners - Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up event listeners'); // Debug log
            
            // Check if all elements exist
            console.log('Upload area:', !!uploadArea);
            console.log('File input:', !!fileInput);
            console.log('Attendees input:', !!attendeesInput);
            
            uploadArea.addEventListener('click', () => {
                console.log('Upload area clicked'); // Debug log
                fileInput.click();
            });
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            fileInput.addEventListener('change', handleFileSelect);
            analyzeBtn.addEventListener('click', analyzeImage);
            clearBtn.addEventListener('click', clearSelection);
            downloadBtn.addEventListener('click', downloadPDF);
            attendeesInput.addEventListener('input', handleAttendeesInput);
        });

        function handleAttendeesInput(e) {
            const input = e.target.value.trim();
            console.log('Attendees input:', input); // Debug log
            
            if (input) {
                attendees = input.split(',')
                    .map(name => name.trim())
                    .filter(name => name.length > 0);
                console.log('Parsed attendees:', attendees); // Debug log
                updateAttendeesPreview();
            } else {
                attendees = [];
                attendeesPreview.innerHTML = '';
            }
        }

        function updateAttendeesPreview() {
            console.log('Updating preview for attendees:', attendees); // Debug log
            attendeesPreview.innerHTML = '';
            
            attendees.forEach(name => {
                const tag = document.createElement('div');
                tag.className = 'attendee-tag';
                tag.textContent = name;
                attendeesPreview.appendChild(tag);
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            console.log('File select triggered'); // Debug log
            const file = e.target.files[0];
            if (file) {
                console.log('File selected:', file.name); // Debug log
                handleFile(file);
            }
        }

        function handleFile(file) {
            console.log('Handling file:', file.name, file.type, file.size); // Debug log
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showError('Please select a valid image file.');
                return;
            }

            // Validate file size (10MB max)
            if (file.size > 10 * 1024 * 1024) {
                showError('File size must be less than 10MB.');
                return;
            }

            selectedFile = file;
            
            // Create preview
            const reader = new FileReader();
            reader.onload = function(e) {
                console.log('File loaded successfully'); // Debug log
                imageDataUrl = e.target.result;
                previewImage.src = imageDataUrl;
                previewContainer.style.display = 'block';
                analyzeBtn.disabled = false;
                clearBtn.style.display = 'inline-block';
                hideError();
            };
            
            reader.onerror = function(e) {
                console.error('File reading error:', e); // Debug log
                showError('Error reading file. Please try again.');
            };
            
            reader.readAsDataURL(file);
        }

        async function analyzeImage() {
            if (!imageDataUrl) {
                showError('Please select an image first.');
                return;
            }

            // Check if API key is available
            if (!API_CONFIG.apiKey) {
                showError('API key not configured. Please check your environment variables.');
                return;
            }

            showLoading();
            hideError();
            hideResults();

            try {
                const response = await fetch(`${API_CONFIG.baseURL}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: API_CONFIG.model,
                        messages: [
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "text",
                                        text: "Convert the image of a bill into key value pairs along with the taxes as a key value pair. Format the response as JSON with clear key-value pairs."
                                    },
                                    {
                                        type: "image_url",
                                        image_url: {
                                            url: imageDataUrl
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 1000
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // Extract JSON from the response (looking for content between <|begin_of_box|> and <|end_of_box|>)
                let extractedData;
                try {
                    const boxMatch = content.match(/<\|begin_of_box\|\>([\s\S]*?)<\|end_of_box\|\>/);
                    if (boxMatch) {
                        extractedData = JSON.parse(boxMatch[1].trim());
                        billData = extractedData;
                        displayBillResults(extractedData);
                    } else {
                        // Fallback to regular JSON parsing
                        const jsonMatch = content.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            extractedData = JSON.parse(jsonMatch[0]);
                            billData = extractedData;
                            displayBillResults(extractedData);
                        } else {
                            // If no structured data found, show as key-value pairs
                            extractedData = parseTextResponse(content);
                            displaySimpleResults(extractedData);
                        }
                    }
                } catch (parseError) {
                    // If JSON parsing fails, parse as text
                    extractedData = parseTextResponse(content);
                    displaySimpleResults(extractedData);
                }
                
            } catch (err) {
                console.error('Analysis error:', err);
                showError(`Analysis failed: ${err.message}`);
            } finally {
                hideLoading();
            }
        }

        function parseTextResponse(text) {
            const data = {};
            const lines = text.split('\n').filter(line => line.trim());
            
            for (const line of lines) {
                if (line.includes(':')) {
                    const [key, ...valueParts] = line.split(':');
                    const value = valueParts.join(':').trim();
                    if (key && value) {
                        data[key.trim().replace(/[^\w\s]/g, '')] = value;
                    }
                }
            }
            
            // If no structured data found, return the raw response
            if (Object.keys(data).length === 0) {
                data['Analysis Result'] = text;
            }
            
            return data;
        }

        function displayBillResults(data) {
            // Display bill summary
            if (data.bill_summary) {
                displayBillSummary(data.bill_summary);
            }
            
            // Display splitting table if attendees are provided and items exist
            if (attendees.length > 0 && data.items && data.items.length > 0) {
                displaySplittingTable(data.items, data.bill_summary);
                downloadBtn.style.display = 'inline-block';
            } else if (data.items && data.items.length > 0) {
                // Show message to add attendees
                splittingTable.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: #fff3cd; border-radius: 10px; margin-top: 20px;">
                        <h4>👥 Add attendees above to enable bill splitting!</h4>
                        <p>Enter names in the "Who's attending?" section to split this bill.</p>
                    </div>
                `;
            }
            
            results.style.display = 'block';
            results.classList.add('success-animation');
        }

        function displayBillSummary(summary) {
            billSummary.innerHTML = `
                <div class="bill-summary">
                    <h4>💰 Bill Summary</h4>
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span>₹${summary.sub_total?.toFixed(2) || '0.00'}</span>
                    </div>
                    <div class="summary-row">
                        <span>Service Charge:</span>
                        <span>₹${summary.service_charge?.toFixed(2) || '0.00'}</span>
                    </div>
                    <div class="summary-row">
                        <span>CGST:</span>
                        <span>₹${summary.cgst?.toFixed(2) || '0.00'}</span>
                    </div>
                    <div class="summary-row">
                        <span>SGST:</span>
                        <span>₹${summary.sgst?.toFixed(2) || '0.00'}</span>
                    </div>
                    <div class="summary-row">
                        <span>Round Off:</span>
                        <span>₹${summary.round_off?.toFixed(2) || '0.00'}</span>
                    </div>
                    <div class="summary-row">
                        <span>Total Payable:</span>
                        <span>₹${summary.total_payable?.toFixed(2) || '0.00'}</span>
                    </div>
                </div>
            `;
        }

        function displaySplittingTable(items, billSummary) {
            const totalTaxes = (billSummary?.service_charge || 0) + (billSummary?.cgst || 0) + (billSummary?.sgst || 0);
            const taxPercentage = billSummary?.sub_total ? (totalTaxes / billSummary.sub_total) : 0;
            
            let tableHTML = `
                <div class="splitting-table">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th class="item-column">Item (Qty × Price)</th>
            `;
            
            // Add attendee columns
            attendees.forEach(attendee => {
                tableHTML += `<th>${attendee}</th>`;
            });
            
            tableHTML += `
                                    <th class="tax-column">Tax Amount</th>
                                    <th class="total-column">Total Amount</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Add item rows
            items.forEach((item, itemIndex) => {
                tableHTML += `
                    <tr>
                        <td class="item-column">
                            <strong>${item.item}</strong><br>
                            <small>${item.qty} × ₹${(item.amount / item.qty).toFixed(2)} = ₹${item.amount.toFixed(2)}</small>
                        </td>
                `;
                
                // Add checkboxes for each attendee
                attendees.forEach((attendee, attendeeIndex) => {
                    tableHTML += `
                        <td class="checkbox-cell">
                            <input type="checkbox" 
                                   id="item_${itemIndex}_person_${attendeeIndex}" 
                                   onchange="updateCalculations()" />
                        </td>
                    `;
                });
                
                tableHTML += `
                        <td class="tax-column amount-cell" id="tax_${itemIndex}">₹0.00</td>
                        <td class="total-column amount-cell" id="total_${itemIndex}">₹0.00</td>
                    </tr>
                `;
            });
            
            // Add totals row for each person
            tableHTML += `
                <tr class="total-row">
                    <td><strong>Total per person:</strong></td>
            `;
            
            attendees.forEach((attendee, attendeeIndex) => {
                tableHTML += `<td class="total-column" id="person_total_${attendeeIndex}"><strong>₹0.00</strong></td>`;
            });
            
            tableHTML += `
                    <td class="tax-column" id="total_tax"><strong>₹0.00</strong></td>
                    <td class="total-column" id="grand_total"><strong>₹0.00</strong></td>
                </tr>
            `;
            
            tableHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            splittingTable.innerHTML = tableHTML;
        }

        function updateCalculations() {
            if (!billData || !billData.items) return;
            
            const items = billData.items;
            const billSummaryData = billData.bill_summary || {};
            const totalTaxes = (billSummaryData.service_charge || 0) + (billSummaryData.cgst || 0) + (billSummaryData.sgst || 0);
            const taxPercentage = billSummaryData.sub_total ? (totalTaxes / billSummaryData.sub_total) : 0;
            
            // Reset totals
            const personTotals = new Array(attendees.length).fill(0);
            let grandTotalTax = 0;
            let grandTotalAmount = 0;
            
            // Calculate for each item
            items.forEach((item, itemIndex) => {
                let selectedCount = 0;
                const checkboxes = [];
                
                // Count selected checkboxes for this item
                attendees.forEach((attendee, attendeeIndex) => {
                    const checkbox = document.getElementById(`item_${itemIndex}_person_${attendeeIndex}`);
                    checkboxes.push(checkbox);
                    if (checkbox && checkbox.checked) {
                        selectedCount++;
                    }
                });
                
                if (selectedCount > 0) {
                    const itemCostPerPerson = item.amount / selectedCount;
                    const itemTaxPerPerson = itemCostPerPerson * taxPercentage;
                    const totalPerPerson = itemCostPerPerson + itemTaxPerPerson;
                    
                    // Update individual totals
                    checkboxes.forEach((checkbox, attendeeIndex) => {
                        if (checkbox && checkbox.checked) {
                            personTotals[attendeeIndex] += totalPerPerson;
                        }
                    });
                    
                    // Update item tax and total
                    const itemTotalTax = item.amount * taxPercentage;
                    const itemTotalAmount = item.amount + itemTotalTax;
                    
                    document.getElementById(`tax_${itemIndex}`).textContent = `₹${itemTotalTax.toFixed(2)}`;
                    document.getElementById(`total_${itemIndex}`).textContent = `₹${itemTotalAmount.toFixed(2)}`;
                    
                    grandTotalTax += itemTotalTax;
                    grandTotalAmount += itemTotalAmount;
                } else {
                    // No one selected this item
                    document.getElementById(`tax_${itemIndex}`).textContent = `₹0.00`;
                    document.getElementById(`total_${itemIndex}`).textContent = `₹0.00`;
                }
            });
            
            // Update person totals
            attendees.forEach((attendee, attendeeIndex) => {
                const totalElement = document.getElementById(`person_total_${attendeeIndex}`);
                if (totalElement) {
                    totalElement.innerHTML = `<strong>₹${personTotals[attendeeIndex].toFixed(2)}</strong>`;
                }
            });
            
            // Update grand totals
            const totalTaxElement = document.getElementById('total_tax');
            const grandTotalElement = document.getElementById('grand_total');
            
            if (totalTaxElement) {
                totalTaxElement.innerHTML = `<strong>₹${grandTotalTax.toFixed(2)}</strong>`;
            }
            
            if (grandTotalElement) {
                grandTotalElement.innerHTML = `<strong>₹${grandTotalAmount.toFixed(2)}</strong>`;
            }
        }

        function displaySimpleResults(data) {
            billSummary.innerHTML = '';
            splittingTable.innerHTML = '';
            
            let pairsHTML = '<h4>📊 Extracted Information</h4>';
            for (const [key, value] of Object.entries(data)) {
                pairsHTML += `
                    <div class="key-value-pair">
                        <span class="key">${key}</span>
                        <span class="value">${value}</span>
                    </div>
                `;
            }
            
            billSummary.innerHTML = pairsHTML;
            results.style.display = 'block';
            results.classList.add('success-animation');
        }

        function downloadPDF() {
            if (!billData || !attendees.length) {
                showError('No bill data available to download.');
                return;
            }

            // Create PDF content
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Set up the document
            doc.setFontSize(20);
            doc.setTextColor(102, 126, 234);
            doc.text('Bill Split Summary', 20, 20);
            
            const currentDate = new Date().toLocaleDateString();
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated on: ${currentDate}`, 20, 30);
            
            let yPosition = 50;
            
            // Bill Summary Section
            if (billData.bill_summary) {
                doc.setFontSize(14);
                doc.setTextColor(51, 51, 51);
                doc.text('Bill Summary', 20, yPosition);
                yPosition += 10;
                
                doc.setFontSize(10);
                const summary = billData.bill_summary;
                doc.text(`Subtotal: ₹${summary.sub_total?.toFixed(2) || '0.00'}`, 20, yPosition);
                yPosition += 6;
                doc.text(`Service Charge: ₹${summary.service_charge?.toFixed(2) || '0.00'}`, 20, yPosition);
                yPosition += 6;
                doc.text(`CGST: ₹${summary.cgst?.toFixed(2) || '0.00'}`, 20, yPosition);
                yPosition += 6;
                doc.text(`SGST: ₹${summary.sgst?.toFixed(2) || '0.00'}`, 20, yPosition);
                yPosition += 6;
                doc.text(`Total Payable: ₹${summary.total_payable?.toFixed(2) || '0.00'}`, 20, yPosition);
                yPosition += 15;
            }
            
            // Attendees Section
            doc.setFontSize(14);
            doc.setTextColor(51, 51, 51);
            doc.text('Attendees', 20, yPosition);
            yPosition += 10;
            
            doc.setFontSize(10);
            doc.text(attendees.join(', '), 20, yPosition);
            yPosition += 20;
            
            // Individual Totals Section
            doc.setFontSize(14);
            doc.text('Individual Totals', 20, yPosition);
            yPosition += 15;
            
            // Calculate individual totals
            const personTotals = calculatePersonTotals();
            
            attendees.forEach((attendee, index) => {
                doc.setFontSize(12);
                doc.setTextColor(102, 126, 234);
                doc.text(`${attendee}: ₹${personTotals[index].toFixed(2)}`, 20, yPosition);
                yPosition += 8;
                
                // Show items for this person
                doc.setFontSize(9);
                doc.setTextColor(100, 100, 100);
                const personItems = getPersonItems(index);
                if (personItems.length > 0) {
                    personItems.forEach(item => {
                        doc.text(`• ${item.name} (₹${item.cost.toFixed(2)})`, 25, yPosition);
                        yPosition += 5;
                    });
                }
                yPosition += 5;
                
                // Check if we need a new page
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
            });
            
            // Detailed Items Section (if space allows)
            if (yPosition < 200) {
                yPosition += 10;
                doc.setFontSize(14);
                doc.setTextColor(51, 51, 51);
                doc.text('Detailed Items', 20, yPosition);
                yPosition += 15;
                
                billData.items.forEach(item => {
                    doc.setFontSize(10);
                    doc.setTextColor(51, 51, 51);
                    doc.text(`${item.item}`, 20, yPosition);
                    doc.text(`Qty: ${item.qty}`, 120, yPosition);
                    doc.text(`Amount: ₹${item.amount.toFixed(2)}`, 160, yPosition);
                    yPosition += 6;
                    
                    // Show who selected this item
                    const selectedBy = getItemSelectedBy(billData.items.indexOf(item));
                    if (selectedBy.length > 0) {
                        doc.setFontSize(8);
                        doc.setTextColor(100, 100, 100);
                        doc.text(`Selected by: ${selectedBy.join(', ')}`, 25, yPosition);
                        yPosition += 5;
                    }
                    yPosition += 3;
                    
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }
                });
            }
            
            // Save the PDF
            doc.save(`bill-split-${currentDate.replace(/\//g, '-')}.pdf`);
        }

        function calculatePersonTotals() {
            const personTotals = new Array(attendees.length).fill(0);
            
            if (!billData || !billData.items) return personTotals;
            
            const items = billData.items;
            const billSummaryData = billData.bill_summary || {};
            const totalTaxes = (billSummaryData.service_charge || 0) + (billSummaryData.cgst || 0) + (billSummaryData.sgst || 0);
            const taxPercentage = billSummaryData.sub_total ? (totalTaxes / billSummaryData.sub_total) : 0;
            
            items.forEach((item, itemIndex) => {
                let selectedCount = 0;
                const selectedPeople = [];
                
                attendees.forEach((attendee, attendeeIndex) => {
                    const checkbox = document.getElementById(`item_${itemIndex}_person_${attendeeIndex}`);
                    if (checkbox && checkbox.checked) {
                        selectedCount++;
                        selectedPeople.push(attendeeIndex);
                    }
                });
                
                if (selectedCount > 0) {
                    const itemCostPerPerson = item.amount / selectedCount;
                    const itemTaxPerPerson = itemCostPerPerson * taxPercentage;
                    const totalPerPerson = itemCostPerPerson + itemTaxPerPerson;
                    
                    selectedPeople.forEach(personIndex => {
                        personTotals[personIndex] += totalPerPerson;
                    });
                }
            });
            
            return personTotals;
        }

        function getPersonItems(personIndex) {
            const personItems = [];
            
            if (!billData || !billData.items) return personItems;
            
            const items = billData.items;
            const billSummaryData = billData.bill_summary || {};
            const totalTaxes = (billSummaryData.service_charge || 0) + (billSummaryData.cgst || 0) + (billSummaryData.sgst || 0);
            const taxPercentage = billSummaryData.sub_total ? (totalTaxes / billSummaryData.sub_total) : 0;
            
            items.forEach((item, itemIndex) => {
                const checkbox = document.getElementById(`item_${itemIndex}_person_${personIndex}`);
                if (checkbox && checkbox.checked) {
                    // Count how many people selected this item
                    let selectedCount = 0;
                    attendees.forEach((attendee, attendeeIndex) => {
                        const cb = document.getElementById(`item_${itemIndex}_person_${attendeeIndex}`);
                        if (cb && cb.checked) selectedCount++;
                    });
                    
                    if (selectedCount > 0) {
                        const itemCostPerPerson = item.amount / selectedCount;
                        const itemTaxPerPerson = itemCostPerPerson * taxPercentage;
                        const totalPerPerson = itemCostPerPerson + itemTaxPerPerson;
                        
                        personItems.push({
                            name: item.item,
                            cost: totalPerPerson
                        });
                    }
                }
            });
            
            return personItems;
        }

        function getItemSelectedBy(itemIndex) {
            const selectedBy = [];
            
            attendees.forEach((attendee, attendeeIndex) => {
                const checkbox = document.getElementById(`item_${itemIndex}_person_${attendeeIndex}`);
                if (checkbox && checkbox.checked) {
                    selectedBy.push(attendee);
                }
            });
            
            return selectedBy;
        }

        // Make updateCalculations available globally
        window.updateCalculations = updateCalculations;

        function clearSelection() {
            selectedFile = null;
            imageDataUrl = null;
            fileInput.value = '';
            previewContainer.style.display = 'none';
            analyzeBtn.disabled = true;
            clearBtn.style.display = 'none';
            downloadBtn.style.display = 'none';
            attendeesInput.value = '';
            attendees = [];
            attendeesPreview.innerHTML = '';
            billData = null;
            hideResults();
            hideError();
            hideLoading();
        }

        function showLoading() {
            loading.style.display = 'block';
            analyzeBtn.disabled = true;
        }

        function hideLoading() {
            loading.style.display = 'none';
            analyzeBtn.disabled = false;
        }

        function showError(message) {
            error.textContent = message;
            error.style.display = 'block';
        }

        function hideError() {
            error.style.display = 'none';
        }

        function hideResults() {
            results.style.display = 'none';
            results.classList.remove('success-animation');
        }
    </script>
</body>
</html>
